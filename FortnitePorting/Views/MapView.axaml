<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:viewModels="clr-namespace:FortnitePorting.ViewModels"
             xmlns:ext="clr-namespace:FortnitePorting.Extensions;assembly=FortnitePorting"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:controls="clr-namespace:FortnitePorting.Controls"
             xmlns:material="clr-namespace:Material.Icons.Avalonia;assembly=Material.Icons.Avalonia"
             xmlns:fortnitePorting="clr-namespace:FortnitePorting"
             xmlns:map="clr-namespace:FortnitePorting.Models.Map"
             xmlns:views="clr-namespace:FortnitePorting.Views"
             d:DesignHeight="770" d:DesignWidth="1160"
             x:Class="FortnitePorting.Views.MapView"
             x:DataType="viewModels:MapViewModel">
    <Grid ColumnDefinitions="Auto *">
        <Grid Grid.Column="1" Margin="{ext:Space 1}"
              VerticalAlignment="Stretch" HorizontalAlignment="Stretch">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="{ext:Space 4}" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="{ext:Space 4}" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <StackPanel Grid.Row="0" VerticalAlignment="Top">
                <TextBlock Text="Map" Classes="BodyStrongTextBlockStyle" Margin="{ext:Space 0, 1, 0, 2}"
                           HorizontalAlignment="Center" VerticalAlignment="Center" />

                <ComboBox SelectedIndex="0"
                          ItemsSource="{Binding Maps}" HorizontalAlignment="Stretch" VerticalAlignment="Center"
                          SelectedItem="{Binding SelectedMap, Mode=TwoWay}" />
            </StackPanel>

            <Separator Grid.Row="1" HorizontalAlignment="Stretch" Margin="0" />

            <StackPanel Grid.Row="2" VerticalAlignment="Top">
                <TextBlock Text="Textures" Classes="BodyStrongTextBlockStyle" Margin="{ext:Space 0, 0, 0, 2}"
                           HorizontalAlignment="Center" VerticalAlignment="Center" />

                <SplitButton HorizontalAlignment="Stretch" Command="{Binding SelectedMap.ExportImageCommand}">
                    <SplitButton.Flyout>
                        <MenuFlyout
                            ItemsSource="{ext:EnumToItemsSource {x:Type map:EMapTextureExportType}}">
                            <MenuFlyout.ItemContainerTheme>
                                <ControlTheme x:DataType="ext:EnumRecord" TargetType="MenuItem"
                                              BasedOn="{StaticResource {x:Type MenuItem}}">
                                    <Setter Property="Header" Value="{Binding Description}" />
                                    <Setter Property="IsEnabled" Value="{Binding !IsDisabled}" />
                                    <Setter Property="Command"
                                            Value="{Binding $parent[views:MapView].((viewModels:MapViewModel)DataContext).SelectedMap.SetTextureExportType}" />
                                    <Setter Property="CommandParameter" Value="{Binding Value}" />

                                    <Setter Property="StaysOpenOnClick" Value="False" />
                                    <Setter Property="Icon">
                                        <Template>
                                            <Grid>
                                                <material:MaterialIcon Kind="Check"
                                                                       IsVisible="{Binding $parent[views:MapView].((viewModels:MapViewModel)DataContext).ExportLocation, 
                                                Converter={StaticResource EnumEquals}, 
                                                ConverterParameter={Binding $parent[MenuItem].((ext:EnumRecord)DataContext).Value}}" />
                                            </Grid>
                                        </Template>
                                    </Setter>
                                </ControlTheme>
                            </MenuFlyout.ItemContainerTheme>
                        </MenuFlyout>
                    </SplitButton.Flyout>
                    
                    <StackPanel Orientation="Horizontal">
                        <material:MaterialIcon Kind="Download" Margin="{ext:Space 0, 0, 1, 0}" />
                        <TextBlock Text="{Binding SelectedMap.TextureExportType, Converter={StaticResource EnumToRecord}, StringFormat='Export {0}'}" />
                    </StackPanel>
                </SplitButton>
            </StackPanel>

            <Separator Grid.Row="3" HorizontalAlignment="Stretch" Margin="0" />

            <Grid Grid.Row="4" VerticalAlignment="Stretch">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="{ext:Space 2}" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="{ext:Space 2}" />
                    <RowDefinition Height="*" />
                    <RowDefinition Height="{ext:Space 1}" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>
                
                
                <TextBlock Grid.Row="0" Text="Export" Classes="BodyStrongTextBlockStyle"
                           HorizontalAlignment="Center" VerticalAlignment="Center"/>


                <Grid Grid.Row="2">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="{ext:Space 1}" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>
                    
                    <Button Grid.Column="0" ToolTip.Tip="Select All Maps"
                            HorizontalAlignment="Stretch"
                            Command="{Binding SelectedMap.SelectAllMapsCommand}"
                            Content="{controls:IconText 'Select All', CheckAll}"/>
                    
                    <Button Grid.Column="2" ToolTip.Tip="Clear Selected Maps"
                            HorizontalAlignment="Stretch"
                            Command="{Binding SelectedMap.ClearSelectedMapsCommand}"
                            IsEnabled="{Binding !!SelectedMap.SelectedMaps.Count}"
                            Content="{controls:IconText 'Clear Selected', Broom}"/>
                </Grid>
                
                <ScrollViewer Grid.Row="4">
                    <ScrollViewer.OpacityMask>
                        <LinearGradientBrush StartPoint="0%, 90%" EndPoint="0%, 100%">
                            <GradientStops>
                                <GradientStop Color="#FFFFFFFF" Offset="0" />
                                <GradientStop Color="#00FFFFFF" Offset="1" />
                            </GradientStops>
                        </LinearGradientBrush>
                    </ScrollViewer.OpacityMask>
                    <ItemsControl ItemsSource="{Binding SelectedMap.SelectedMaps, Mode=TwoWay}"
                                  HorizontalAlignment="Stretch">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <controls:ContentCard Background="{Binding BackgroundBrush}"
                                                      Padding="{ext:Space 1}" Margin="{ext:Space 0, 0, 0, 0.5}"
                                                      HorizontalAlignment="Stretch"
                                                      PointerPressed="OnMapPressed">
                                    <TextBlock Text="{Binding Name}"
                                               HorizontalAlignment="Center" VerticalAlignment="Center"
                                               Classes="BodyStrongTextBlockStyle" />
                                </controls:ContentCard>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel Orientation="Vertical" Spacing="{ext:Space 1}" />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                    </ItemsControl>
                </ScrollViewer>

                <TextBlock Grid.Row="4" Text="No Grids Selected" TextAlignment="Center" FontFamily="{StaticResource SFTextRegular}"
                           Classes="TextFillColorSecondaryBrush"
                           HorizontalAlignment="Center" VerticalAlignment="Center"
                           IsVisible="{Binding !SelectedMap.SelectedMaps.Count}">
                </TextBlock>
                
                <Grid Grid.Row="6" VerticalAlignment="Bottom">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="{ext:Space 1}" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="{ext:Space 1}" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    
                    <DropDownButton Grid.Column="0" HorizontalAlignment="Stretch">
                        <DropDownButton.Flyout>
                            <MenuFlyout>
                                <MenuItem Header="Actors" Classes="Checked"
                                          IsChecked="{Binding SelectedMap.WorldFlagsActors, Mode=TwoWay}" />
                                <MenuItem Header="Instanced &amp; Foliage Actors" Classes="Checked"
                                          IsEnabled="{Binding SelectedMap.WorldFlagsActors, Mode=TwoWay}"
                                          IsChecked="{Binding SelectedMap.WorldFlagsInstancedFoliage, Mode=TwoWay}" />
                                <MenuItem Header="Main Level" Classes="Checked"
                                          IsChecked="{Binding SelectedMap.WorldFlagsMainLevel, Mode=TwoWay}" />
                                <MenuItem Header="Landscape" Classes="Checked"
                                          IsEnabled="{Binding SelectedMap.WorldFlagsMainLevel, Mode=TwoWay}"
                                          IsChecked="{Binding SelectedMap.WorldFlagsLandscape, Mode=TwoWay}"/>
                                <MenuItem Header="HLODs" Classes="Checked"
                                          IsChecked="{Binding SelectedMap.WorldFlagsHLODs, Mode=TwoWay}" />

                            </MenuFlyout>
                        </DropDownButton.Flyout>

                        <StackPanel Orientation="Horizontal">
                            <material:MaterialIcon Kind="Flag" Margin="{ext:Space 0, 0, 1, 0}" />
                            <TextBlock Text="Flags" />
                        </StackPanel>
                    </DropDownButton>

                    <SplitButton Grid.Column="2" HorizontalAlignment="Stretch" IsEnabled="{Binding SelectedMap.CanExport}"
                                 Command="{Binding SelectedMap.ExportCommand}">
                        <SplitButton.Flyout>
                            <MenuFlyout
                                ItemsSource="{ext:EnumToItemsSource {x:Type fortnitePorting:EExportLocation}}">
                                <MenuFlyout.ItemContainerTheme>
                                    <ControlTheme x:DataType="ext:EnumRecord" TargetType="MenuItem"
                                                  BasedOn="{StaticResource {x:Type MenuItem}}">
                                        <Setter Property="Header" Value="{Binding Description}" />
                                        <Setter Property="IsEnabled" Value="{Binding !IsDisabled}" />
                                        <Setter Property="Command"
                                                Value="{Binding $parent[views:MapView].((viewModels:MapViewModel)DataContext).SetExportLocationCommand}" />
                                        <Setter Property="CommandParameter" Value="{Binding Value}" />

                                        <Setter Property="StaysOpenOnClick" Value="False" />
                                        <Setter Property="Icon">
                                            <Template>
                                                <Grid>
                                                    <material:MaterialIcon Kind="Check"
                                                                           IsVisible="{Binding $parent[views:MapView].((viewModels:MapViewModel)DataContext).ExportLocation, 
                                                Converter={StaticResource EnumEquals}, 
                                                ConverterParameter={Binding $parent[MenuItem].((ext:EnumRecord)DataContext).Value}}" />
                                                </Grid>
                                            </Template>
                                        </Setter>
                                    </ControlTheme>
                                </MenuFlyout.ItemContainerTheme>
                            </MenuFlyout>
                        </SplitButton.Flyout>
                        <StackPanel Orientation="Horizontal">
                            <material:MaterialIcon Kind="Download" Margin="{ext:Space 0, 0, 1, 0}" />
                            <TextBlock
                                Text="{Binding ExportLocation, Converter={StaticResource EnumToRecord}, StringFormat='Export to {0}'}" />
                        </StackPanel>
                    </SplitButton>

                    <Button Grid.Column="4" ToolTip.Tip="Export Settings"
                            Content="{material:MaterialIconExt Settings}"
                            Command="{Binding OpenSettingsCommand}" />

                </Grid>

            </Grid>
        </Grid>


        <Grid Grid.Column="0" Margin="{ext:Space 1}">
            <Border CornerRadius="12" ClipToBounds="True">
                <Viewbox x:Name="MapBox" StretchDirection="Both" Stretch="Uniform" Cursor="Hand"
                         HorizontalAlignment="Stretch" VerticalAlignment="Stretch"
                         RenderTransform="{Binding MapTransform}" PointerWheelChanged="OnScrollWheel"
                         PointerMoved="OnPointerMoved">
                    <Grid>
                        <Border CornerRadius="0" ClipToBounds="True">
                            <Image x:Name="MapImage"
                                   Source="{Binding SelectedMap.MapBitmap, TargetNullValue=Assets/Transparent1x1.png}" />
                        </Border>
                        <ItemsControl x:Name="GridsControl" ItemsSource="{Binding SelectedMap.Grids}"
                                      Width="{Binding Bounds.Width, ElementName=MapImage}"
                                      Height="{Binding Bounds.Height, ElementName=MapImage}">
                            <ItemsControl.OpacityMask>
                                <ImageBrush Source="{Binding SelectedMap.MaskBitmap}" TransformOrigin="50%,50%">
                                    <ImageBrush.Transform>
                                        <ScaleTransform ScaleX="1" ScaleY="1" />
                                    </ImageBrush.Transform>
                                </ImageBrush>
                            </ItemsControl.OpacityMask>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border ToolTip.Tip="{Binding ToolTipNames}" Opacity="0.35"
                                            Background="{Binding GridBrush}" BorderBrush="White"
                                            BorderThickness="2" PointerPressed="OnCellPressed"
                                            CornerRadius="0" Padding="0" IsHitTestVisible="True"
                                            Width="{Binding CellSize}" Height="{Binding CellSize}"
                                            Margin="{Binding OffsetMargin}" />
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <Grid />
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                        </ItemsControl>
                    </Grid>
                </Viewbox>
            </Border>

            <controls:ContentCard CornerRadius="12" Background="Transparent" IsHitTestVisible="False" />
        </Grid>

        <Grid Grid.Column="0" Width="{Binding $parent[views:MapView].Bounds.Height}">
            <TextBlock Text="A preview of this map is not available."
                       HorizontalAlignment="Center" VerticalAlignment="Center"
                       Classes="BodyTextBlockStyle TextFillColorTertiaryBrush">
                <TextBlock.IsVisible>
                    <MultiBinding Converter="{x:Static BoolConverters.And}">
                        <Binding Path="!SelectedMap.SelectedMaps.Count" />
                        <Binding Path="SelectedMap.MapInfo.IsNonDisplay" />
                    </MultiBinding>
                </TextBlock.IsVisible>
            </TextBlock>
        </Grid>
    </Grid>
</UserControl>